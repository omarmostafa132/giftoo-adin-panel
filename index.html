<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giftoo - لوحة التحكم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary-color:#000000;--secondary-color:#ffffff;--accent-color:#25D366;--discount-color:#e63946;--light-gray:#f5f5f5;--dark-gray:#333333;}*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}body{background-color:var(--secondary-color);color:var(--primary-color);padding:20px;direction:rtl;}
        .login-container{display:flex;justify-content:center;align-items:center;height:100vh;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.8);z-index:1000;}
        .login-form{background-color:white;padding:30px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);width:400px;max-width:90%;}
        .login-form h2{text-align:center;margin-bottom:20px;color:var(--primary-color);}
        .login-form input{width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--light-gray);border-radius:4px;font-size:16px;}
        .login-form button{width:100%;padding:12px;background-color:var(--accent-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:bold;}
        .password-settings{margin-top:20px;padding:20px;background-color:var(--light-gray);border-radius:8px;}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:15px;border-bottom:1px solid var(--light-gray);}
        .logo{display:flex;align-items:center;gap:10px;font-size:1.8rem;font-weight:bold;}
        .tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid var(--light-gray);padding-bottom:10px;flex-wrap:wrap;}
        .tab{padding:8px 16px;cursor:pointer;border-radius:4px;}
        .tab.active{background-color:var(--accent-color);color:white;}
        .tab-content{display:none;}
        .tab-content.active{display:block;}
        .form-group{margin-bottom:15px;}
        .form-group label{display:block;margin-bottom:5px;font-weight:500;}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--light-gray);border-radius:4px;}
        .form-group textarea{min-height:100px;resize:vertical;}
        .form-row{display:flex;gap:15px;}
        .form-row .form-group{flex:1;}
        .btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:500;}
        .btn-primary{background-color:var(--accent-color);color:white;}
        .btn-secondary{background-color:var(--light-gray);color:var(--primary-color);}
        table{width:100%;border-collapse:collapse;margin-top:20px;}
        th,td{padding:12px 15px;text-align:right;border-bottom:1px solid var(--light-gray);}
        th{background-color:var(--light-gray);font-weight:600;}
        .product-image{width:60px;height:60px;object-fit:cover;border-radius:4px;}
        .action-btn{background:none;border:none;cursor:pointer;font-size:1rem;margin:0 5px;padding:5px;}
        .edit-btn{color:var(--accent-color);}
        .delete-btn{color:var(--discount-color);}
        .status-badge{padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:500;}
        .in-stock{background-color:#e8f5e9;color:#2e7d32;}
        .sold-out{background-color:#ffebee;color:#c62828;}
        .categories-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:20px;}
        .category-card{background-color:var(--secondary-color);padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);width:calc(33.333% - 10px);display:flex;justify-content:space-between;align-items:center;}
        .category-image{width:60px;height:60px;object-fit:cover;border-radius:4px;margin-left:15px;}
        .category-info{display:flex;align-items:center;flex:1;}
        .category-actions{display:flex;gap:5px;}
        .image-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
        .image-preview-item{position:relative;width:100px;height:100px;}
        .image-preview-item img{width:100%;height:100%;object-fit:cover;border-radius:4px;}
        .image-preview-item .remove-image{position:absolute;top:5px;left:5px;background-color:var(--discount-color);color:white;border:none;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;}
        .upload-area{border:2px dashed var(--light-gray);border-radius:4px;padding:20px;text-align:center;margin-bottom:15px;cursor:pointer;transition:border-color 0.3s;}
        .upload-area:hover{border-color:var(--accent-color);}
        .upload-area i{font-size:2rem;color:var(--accent-color);margin-bottom:10px;}
        .progress-container{margin-top:10px;display:none;}
        .progress-bar{width:100%;background-color:var(--light-gray);border-radius:4px;overflow:hidden;}
        .progress-bar-fill{height:20px;background-color:var(--accent-color);width:0%;transition:width 0.3s;}
        .progress-text{text-align:center;margin-top:5px;font-size:0.8rem;}
        .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:20px;}
        .promo-codes-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px;}
        .promo-card{background-color:var(--secondary-color);padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;}
        .promo-info{flex:1;}
        .promo-code{font-weight:bold;font-size:1.1rem;margin-bottom:5px;}
        .promo-value{color:var(--dark-gray);}
        .promo-actions{display:flex;gap:5px;}
        .product-card{background-color:var(--secondary-color);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden;}
        .product-card-img{width:100%;height:200px;object-fit:cover;}
        .product-card-body{padding:15px;}
        .product-card-title{font-size:1.1rem;margin-bottom:8px;font-weight:600;}
        .product-card-category{font-size:0.9rem;color:var(--dark-gray);margin-bottom:8px;}
        .product-card-price{font-weight:600;margin-bottom:8px;}
        .product-card-old-price{text-decoration:line-through;color:var(--dark-gray);font-size:0.9rem;margin-right:5px;}
        .product-card-discount{color:var(--discount-color);font-weight:600;margin-bottom:8px;}
        .product-card-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;border-top:1px solid var(--light-gray);}
        .product-badge{padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:500;}
        .badge-best-seller{background-color:#e3f2fd;color:#1976d2;}
        .badge-offer{background-color:#fff8e1;color:#ff8f00;}
        .users-table-container{margin-top:20px;overflow-x:auto;}
        .download-btn{background-color:#4CAF50;color:white;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:20px;display:inline-flex;align-items:center;gap:5px;}
        .orders-container{margin-top:20px;}
        .order-card{background-color:var(--secondary-color);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;padding:15px;width:100%;}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--light-gray);}
        .order-id{font-weight:bold;font-size:1.1rem;}
        .order-date{color:var(--dark-gray);font-size:0.9rem;}
        .order-customer{margin-bottom:15px;}
        .customer-name{font-weight:600;margin-bottom:5px;font-size:1.1rem;}
        .customer-details{font-size:0.9rem;color:var(--dark-gray);}
        .order-products{margin-bottom:15px;}
        .product-item{display:flex;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--light-gray);}
        .product-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
        .product-item-img{width:50px;height:50px;object-fit:cover;border-radius:4px;margin-left:10px;}
        .product-item-details{flex:1;}
        .product-item-name{font-weight:600;margin-bottom:3px;}
        .product-item-size, .product-item-color {font-size:0.8rem;color:var(--dark-gray);margin-top:2px;}
        .product-item-price{font-size:0.9rem;color:var(--dark-gray);}
        .product-item-quantity{font-size:0.9rem;color:var(--dark-gray);}
        .order-summary{display:flex;justify-content:space-between;margin-bottom:15px;padding-top:10px;border-top:1px solid var(--light-gray);}
        .order-total{font-weight:600;}
        .order-status{display:flex;align-items:center;justify-content:space-between;}
        .status-select{padding:8px;border-radius:4px;border:1px solid var(--light-gray);font-size:0.9rem;}
        .status-badge{padding:5px 10px;border-radius:4px;font-size:0.8rem;font-weight:500;}
        .status-pending{background-color:#fff3cd;color:#856404;}
        .status-processing{background-color:#e3f2fd;color:#1976d2;}
        .status-shipped{background-color:#d1ecf1;color:#0c5460;}
        .status-delivered{background-color:#e8f5e9;color:#2e7d32;}
        .status-cancelled{background-color:#ffebee;color:#c62828;}
        .reviews-container{margin-top:20px;overflow-x:auto;}
        .review-table{width:100%;border-collapse:collapse;}
        .review-table th{background-color:var(--light-gray);padding:12px;text-align:right;font-weight:600;}
        .review-table td{padding:12px;border-bottom:1px solid var(--light-gray);}
        .review-rating{color:#ffc107;}
        .announcement-form{background-color:var(--light-gray);padding:20px;border-radius:8px;margin-bottom:20px;}
        .announcement-toggle{display:flex;align-items:center;gap:10px;margin-bottom:15px;}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;}
        .toggle-switch input{opacity:0;width:0;height:0;}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px;}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}
        input:checked+.toggle-slider{background-color:var(--accent-color);}
        input:checked+.toggle-slider:before{transform:translateX(26px);}
        .active-status{display:flex;align-items:center;gap:10px;}
        .promo-active-badge{padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:500;}
        .active-true{background-color:#e8f5e9;color:#2e7d32;}
        .active-false{background-color:#ffebee;color:#c62828;}
        .order-details-toggle{background:none;border:none;color:var(--accent-color);cursor:pointer;font-size:0.9rem;margin-top:10px;display:flex;align-items:center;gap:5px;}
        .order-details-content{margin-top:15px;padding:15px;background-color:var(--light-gray);border-radius:8px;display:none;}
        .order-details-content.show{display:block;}
        .detail-row{display:flex;margin-bottom:10px;}
        .detail-label{font-weight:600;width:150px;}
        .detail-value{flex:1;}
        .analytics-container{margin-top:20px;}
        .analytics-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;}
        .analytics-card{background-color:var(--secondary-color);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:20px;text-align:center;}
        .analytics-card h3{margin-bottom:10px;color:var(--dark-gray);font-size:1rem;}
        .analytics-card .value{font-size:2rem;font-weight:bold;color:var(--accent-color);}
        .analytics-card .subtext{font-size:0.9rem;color:var(--dark-gray);margin-top:5px;}
        .charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px;margin-bottom:30px;}
        .chart-container{background-color:var(--secondary-color);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:20px;width:100%;}
        .chart-container h3{margin-bottom:15px;text-align:center;}
        .chart-wrapper{position:relative;height:300px;}
        .dynamic-field-container{margin-bottom:10px;padding:10px;border:1px solid var(--light-gray);border-radius:4px;}
        .dynamic-field-row{display:flex;gap:10px;margin-bottom:10px;}
        .dynamic-field-row input{flex:1;}
        .remove-field-btn{background-color:var(--discount-color);color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;}
        .add-field-btn{margin-bottom:15px;}
        .stock-option{display:flex;align-items:center;gap:10px;}
        .stock-input-container{display:none;margin-top:10px;}
        .stock-input-container.visible{display:block;}
        .about-us-container{margin-top:20px;}
        .about-us-content{background-color:var(--light-gray);padding:20px;border-radius:8px;margin-bottom:20px;min-height:200px;}
        .review-form-container{background-color:var(--light-gray);padding:20px;border-radius:8px;margin-bottom:20px;}
        .review-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;margin-top:20px;}
        .review-card{background-color:var(--secondary-color);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:15px;display:flex;flex-direction:column;}
        .review-card-header{display:flex;align-items:center;margin-bottom:10px;}
        .review-product-image{width:60px;height:60px;object-fit:cover;border-radius:4px;margin-left:10px;}
        .review-product-info{flex:1;}
        .review-product-name{font-weight:600;margin-bottom:5px;}
        .review-rating-stars{color:#ffc107;margin-bottom:5px;}
        .review-comment{margin-bottom:10px;color:var(--dark-gray);}
        .review-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto;}
        .review-date{font-size:0.8rem;color:var(--dark-gray);}
        .review-actions{display:flex;gap:5px;}
        .review-card .action-btn{background:none;border:none;cursor:pointer;font-size:1rem;padding:5px;}
        .review-card .delete-btn{color:var(--discount-color);}
        .review-details-toggle{background:none;border:none;color:var(--accent-color);cursor:pointer;font-size:0.9rem;margin-top:10px;display:flex;align-items:center;gap:5px;}
        .review-details-content{margin-top:15px;padding:15px;background-color:var(--light-gray);border-radius:8px;display:none;}
        .review-details-content.show{display:block;}
        .customer-data-toggle{background:none;border:none;color:var(--accent-color);cursor:pointer;font-size:0.9rem;margin-top:10px;display:flex;align-items:center;gap:5px;}
        .customer-data-content{margin-top:15px;padding:15px;background-color:var(--light-gray);border-radius:8px;display:none;}
        .customer-data-content.show{display:block;}

        /* Shipping Costs Styles */
        .shipping-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 10px;
        }
        
        .shipping-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--secondary-color);
            color: var(--dark-gray);
        }
        
        .save-shipping-btn {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s;
        }
        
        .save-shipping-btn:hover {
            background-color: #1da84e;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #4caf50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        /* Order Delete Button */
        .order-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .delete-order-btn {
            background-color: var(--discount-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .delete-order-btn:hover {
            background-color: #c62828;
        }

        @media (max-width:768px){.form-row{flex-direction:column;gap:0;}
        .category-card{width:100%;}
        .products-grid{grid-template-columns:1fr;}
        .promo-codes-list{grid-template-columns:1fr;}
        .order-header{flex-direction:column;align-items:flex-start;}
        .order-date{margin-top:5px;}
        .order-status{flex-direction:column;align-items:flex-start;}
        .status-select{margin-top:10px;width:100%;}
        .detail-row{flex-direction:column;}
        .detail-label{width:100%;margin-bottom:5px;}
        .charts-container{grid-template:1fr;}
        .chart-container{padding:15px;}
        .chart-wrapper{height:250px;}
        .dynamic-field-row{flex-direction:column;gap:5px;}
        .stock-option{flex-direction:column;align-items:flex-start;gap:5px;}
        .review-cards{grid-template-columns:1fr;}
        .shipping-form{grid-template-columns:1fr;gap:15px;}
        .order-actions{flex-direction:column;width:100%;}}
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>تسجيل الدخول إلى لوحة التحكم</h2>
            <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور">
            <button id="loginBtn">دخول</button>
        </div>
    </div>
    <div id="adminPanel" style="display: none;">
        <div class="header">
            <div class="logo">
                <span>لوحة تحكم Giftoo</span>
            </div>
            <button class="btn btn-secondary" id="logoutBtn">تسجيل الخروج</button>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="products">إضافة منتج</div>
            <div class="tab" data-tab="manage-products">إدارة المنتجات</div>
            <div class="tab" data-tab="categories">الفئات</div>
            <div class="tab" data-tab="promo-codes">رموز التخفيض</div>
            <div class="tab" data-tab="orders">الطلبات</div>
            <div class="tab" data-tab="reviews">التقييمات</div>
            <div class="tab" data-tab="users">المستخدمين</div>
            <div class="tab" data-tab="shipping-costs">تكاليف الشحن</div>
            <div class="tab" data-tab="announcement">الإعلانات</div>
            <div class="tab" data-tab="hero-banner">اللافتة الرئيسية</div>
            <div class="tab" data-tab="about-us">معلومات المتجر</div>
            <div class="tab" data-tab="password-settings">إعدادات كلمة المرور</div>
            <div class="tab" data-tab="analytics">التحليلات</div>
        </div>
        <div class="tab-content active" id="products-tab">
            <div class="form-container">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">اسم المنتج</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">الفئة</label>
                            <select id="productCategory" required>
                                <option value="">اختر فئة</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrice">السعر (ج.م)</label>
                            <input type="number" id="productPrice" required>
                        </div>
                        <div class="form-group">
                            <label for="originalPrice">السعر قبل التخفيض (ج.م) - اختياري</label>
                            <input type="number" id="originalPrice">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockOption">خيار المخزون</label>
                            <select id="stockOption" required>
                                <option value="none">لا تضيف مخزون</option>
                                <option value="quantity">إضافة كمية محددة</option>
                                <option value="soldout">وضع (تم البيع)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group stock-input-container" id="stockQuantityContainer">
                        <label for="stockQuantity">الكمية المتاحة</label>
                        <input type="number" id="stockQuantity" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="productDescription">الوصف</label>
                        <textarea id="productDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>الألوان</label>
                        <div id="colorsContainer"></div>
                        <button type="button" class="btn btn-secondary add-field-btn" id="addColorBtn">إضافة لون</button>
                    </div>
                    <div class="form-group">
                        <label>المقاسات</label>
                        <div id="sizesContainer"></div>
                        <button type="button" class="btn btn-secondary add-field-btn" id="addSizeBtn">إضافة مقاس</button>
                    </div>
                    <div class="form-group">
                        <label>صور المنتج</label>
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>انقر لرفع الصور أو اسحبها وأفلتها (يُسمح برفع عدة صور)</p>
                            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="progressBarFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="image-preview" id="imagePreview"></div>
                        <input type="hidden" id="productImageUrls">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">حفظ المنتج</button>
                        <button type="button" class="btn btn-secondary" id="cancelProductBtn">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="tab-content" id="manage-products-tab">
            <div class="products-grid" id="productsGrid"></div>
        </div>
        <div class="tab-content" id="categories-tab">
            <div class="form-container">
                <form id="categoryForm">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="categoryName">اسم الفئة</label>
                            <input type="text" id="categoryName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>صورة الفئة</label>
                        <div class="upload-area" id="categoryUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>انقر لرفع صورة الفئة أو اسحبها وأفلتها</p>
                            <input type="file" id="categoryFileInput" accept="image/*" style="display: none;">
                        </div>
                        <div class="progress-container" id="categoryProgressContainer">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="categoryProgressBarFill"></div>
                            </div>
                        </div>
                        <div class="image-preview" id="categoryImagePreview"></div>
                        <input type="hidden" id="categoryImageUrl">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">إضافة فئة</button>
                    </div>
                </form>
            </div>
            <div class="categories-list" id="categoriesList"></div>
        </div>
        <div class="tab-content" id="promo-codes-tab">
            <div class="form-container">
                <form id="promoCodeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="promoCode">رمز التخفيض</label>
                            <input type="text" id="promoCode" required>
                        </div>
                        <div class="form-group">
                            <label for="promoDiscount">قيمة الخصم (ج.م)</label>
                            <input type="number" id="promoDiscount" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="active-status">
                                <label for="promoActive">نشط:</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="promoActive" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">إضافة رمز تخفيض</button>
                    </div>
                </form>
            </div>
            <div class="promo-codes-list" id="promoCodesList"></div>
        </div>
        <div class="tab-content" id="orders-tab">
            <h2>إدارة الطلبات</h2>
            <p>عرض وإدارة طلبات العملاء.</p>
            <div class="orders-container" id="ordersContainer"></div>
        </div>
        <div class="tab-content" id="reviews-tab">
            <h2>إدارة التقييمات</h2>
            <p>عرض وإدارة تقييمات المنتجات.</p>
            <div class="review-form-container">
                <h3>إضافة تقييم جديد</h3>
                <form id="reviewForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reviewProductName">اسم المنتج</label>
                            <input type="text" id="reviewProductName" placeholder="أدخل اسم المنتج" required>
                        </div>
                        <div class="form-group">
                            <label for="reviewerName">اسم المقيّم</label>
                            <input type="text" id="reviewerName" placeholder="أدخل اسم المقيّم" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reviewRating">التقييم</label>
                            <select id="reviewRating" required>
                                <option value="">اختر التقييم</option>
                                <option value="1">1 نجمة</option>
                                <option value="2">2 نجمات</option>
                                <option value="3">3 نجمات</option>
                                <option value="4">4 نجمات</option>
                                <option value="5">5 نجمات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reviewDate">تاريخ التقييم</label>
                            <input type="datetime-local" id="reviewDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reviewText">نص التقييم</label>
                        <textarea id="reviewText" placeholder="أدخل نص التقييم"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">إضافة التقييم</button>
                    </div>
                </form>
            </div>
            <div class="reviews-container">
                <div class="review-cards" id="reviewCards"></div>
            </div>
        </div>
        <div class="tab-content" id="users-tab">
            <h2>إدارة المستخدمين</h2>
            <p>عرض وتنزيل بيانات المستخدمين من قاعدة البيانات.</p>
            <div class="users-table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>الهاتف</th>
                            <th>تاريخ التسجيل</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
            <button class="download-btn" id="downloadUsersBtn">
                <i class="fas fa-download"></i> تنزيل المستخدمين كملف CSV
            </button>
        </div>
        <div class="tab-content" id="shipping-costs-tab">
            <h2>إدارة تكاليف الشحن</h2>
            <p>إدارة أسعار الشحن للمحافظات المختلفة في مصر.</p>
            <div id="adminShippingList"></div>
        </div>
        <div class="tab-content" id="announcement-tab">
            <h2>لافتة الإعلان</h2>
            <p>إدارة لافتة الإعلان المعروضة للمستخدمين.</p>
            <div class="announcement-form">
                <form id="announcementForm">
                    <div class="announcement-toggle">
                        <label for="announcementEnabled">تفعيل اللافتة:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="announcementEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="announcementText">نص الإعلان</label>
                            <textarea id="announcementText" placeholder="أدخل نص الإعلان"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                    </div>
                </form>
            </div>
            <h3>معاينة</h3>
            <div id="announcementPreview" style="background-color: #fff8e1; padding: 15px; border-radius:8px; display: none;">
                <p id="previewText"></p>
            </div>
        </div>
        <div class="tab-content" id="hero-banner-tab">
            <h2>اللافتة الرئيسية</h2>
            <p>رفع صورة اللافتة الرئيسية للمتجر. سيتم استبدال الصورة الحالية في حال رفع صورة جديدة.</p>
            <div class="form-container">
                <div class="upload-area" id="heroUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>انقر لرفع الصورة أو اسحبها وأفلتها هنا</p>
                    <input type="file" id="heroFileInput" accept="image/*" style="display: none;">
                </div>
                <div class="progress-container" id="heroProgressContainer">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="heroProgressBarFill"></div>
                    </div>
                    <div class="progress-text" id="heroProgressText">0%</div>
                </div>
                <div class="image-preview" id="heroImagePreview"></div>
            </div>
        </div>
        <div class="tab-content" id="about-us-tab">
            <h2>معلومات المتجر</h2>
            <p>إدارة معلومات "عن المتجر" المعروضة للعملاء.</p>
            <div class="form-container">
                <form id="aboutUsForm">
                    <div class="form-group">
                        <label for="aboutUsText">معلومات عن المتجر</label>
                        <textarea id="aboutUsText" placeholder="أدخل معلومات عن المتجر"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">حفظ المعلومات</button>
                    </div>
                </form>
            </div>
            <div class="about-us-container">
                <h3>المحتوى الحالي:</h3>
                <div class="about-us-content" id="aboutUsContent"></div>
            </div>
        </div>
        <div class="tab-content" id="password-settings-tab">
            <h2>إعدادات كلمة المرور</h2>
            <p>إدارة كلمة مرور لوحة التحكم.</p>
            <div class="password-settings">
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="newPassword">كلمة المرور الجديدة (اتركها فارغة إذا كنت لا تريد تغييرها)</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">تأكيد كلمة المرور</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">حفظ كلمة المرور</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="tab-content" id="analytics-tab">
            <h2>لوحة التحليلات</h2>
            <p>عرض مقاييس أداء المتجر والتحليلات.</p>
            <div class="analytics-container">
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <h3>إجمالي الإيرادات</h3>
                        <div class="value" id="totalRevenue">0 ج.م</div>
                        <div class="subtext">من الطلبات التي تم تسليمها فقط</div>
                    </div>
                    <div class="analytics-card">
                        <h3>إجمالي الطلبات</h3>
                        <div class="value" id="totalOrders">0</div>
                        <div class="subtext">جميع حالات الطلبات</div>
                    </div>
                    <div class="analytics-card">
                        <h3>الطلبات المسلمة</h3>
                        <div class="value" id="deliveredOrders">0</div>
                        <div class="subtext">المبيعات المكتملة</div>
                    </div>
                    <div class="analytics-card">
                        <h3>متوسط قيمة الطلب</h3>
                        <div class="value" id="avgOrderValue">0 ج.م</div>
                        <div class="subtext">من الطلبات المسلمة</div>
                    </div>
                    <div class="analytics-card">
                        <h3>إجمالي العملاء</h3>
                        <div class="value" id="totalCustomers">0</div>
                        <div class="subtext">عملاء فريدون</div>
                    </div>
                    <div class="analytics-card">
                        <h3>معدل التحويل</h3>
                        <div class="value" id="conversionRate">0%</div>
                        <div class="subtext">الطلبات مقابل الزوار</div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-container">
                        <h3>الطلبات حسب الحالة</h3>
                        <div class="chart-wrapper">
                            <canvas id="ordersStatusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>الإيرادات حسب الشهر</h3>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>المنتجات الأكثر مبيعًا</h3>
                        <div class="chart-wrapper">
                            <canvas id="topProductsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>أداء الفئات</h3>
                        <div class="chart-wrapper">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>اكتساب العملاء</h3>
                        <div class="chart-wrapper">
                            <canvas id="customerChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>تقييمات التقييمات</h3>
                        <div class="chart-wrapper">
                            <canvas id="ratingsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Element -->
    <div class="notification" id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfN0P8kQ7tUcL8QcV7sQ9Q8Q9Q8Q9Q8Q9Q8Q9",
            authDomain: "giffo-faaf7.firebaseapp.com",
            databaseURL: "https://giffo-faaf7-default-rtdb.firebaseio.com",
            projectId: "giffo-faaf7",
            storageBucket: "giffo-faaf7.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:1234567890123456789012"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const IMGBB_API_KEY = '9863a0b56c4ed85517bda67706e834f8';
        let products = [], categories = [], promoCodes = [], users = [], orders = [], reviews = [];
        let uploadedImages = [], uploadedCategoryImage = null, announcement = { enabled: false, text: "" };
        let aboutUs = { text: "" }, heroBanner = null;
        let adminPassword = "";
        let ordersStatusChart = null, revenueChart = null, topProductsChart = null;
        let categoryChart = null, customerChart = null, ratingsChart = null;
        
        // Shipping costs data
        let shippingCosts = {};
        
        // Updated list of 27 Egyptian governments
        const egyptGovernments = [
            "القاهرة",
            "الجيزة",
            "الإسكندرية",
            "القليوبية",
            "الدقهلية",
            "الشرقية",
            "كفر الشيخ",
            "الغربية",
            "المنوفية",
            "البحيرة",
            "الإسماعيلية",
            "بورسعيد",
            "السويس",
            "دمياط",
            "مطروح",
            "شمال سيناء",
            "جنوب سيناء",
            "الفيوم",
            "بني سويف",
            "المنيا",
            "أسيوط",
            "الوادي الجديد",
            "سوهاج",
            "قنا",
            "الأقصر",
            "أسوان",
            "البحر الأحمر"
        ];
        
        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        const loginContainer = document.getElementById('loginContainer');
        const adminPanel = document.getElementById('adminPanel');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const productForm = document.getElementById('productForm');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        const productsGrid = document.getElementById('productsGrid');
        const categoryForm = document.getElementById('categoryForm');
        const categoriesList = document.getElementById('categoriesList');
        const productCategorySelect = document.getElementById('productCategory');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const productImageUrls = document.getElementById('productImageUrls');
        const progressContainer = document.getElementById('progressContainer');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressText = document.getElementById('progressText');
        const promoCodeForm = document.getElementById('promoCodeForm');
        const promoCodesList = document.getElementById('promoCodesList');
        const usersTableBody = document.getElementById('usersTableBody');
        const downloadUsersBtn = document.getElementById('downloadUsersBtn');
        const ordersContainer = document.getElementById('ordersContainer');
        const reviewCardsContainer = document.getElementById('reviewCards');
        const announcementForm = document.getElementById('announcementForm');
        const announcementEnabled = document.getElementById('announcementEnabled');
        const announcementText = document.getElementById('announcementText');
        const announcementPreview = document.getElementById('announcementPreview');
        const previewText = document.getElementById('previewText');
        const passwordForm = document.getElementById('passwordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const aboutUsForm = document.getElementById('aboutUsForm');
        const aboutUsText = document.getElementById('aboutUsText');
        const aboutUsContent = document.getElementById('aboutUsContent');
        const categoryUploadArea = document.getElementById('categoryUploadArea');
        const categoryFileInput = document.getElementById('categoryFileInput');
        const categoryImagePreview = document.getElementById('categoryImagePreview');
        const categoryProgressContainer = document.getElementById('categoryProgressContainer');
        const categoryProgressBarFill = document.getElementById('categoryProgressBarFill');
        const categoryImageUrl = document.getElementById('categoryImageUrl');
        const totalRevenueEl = document.getElementById('totalRevenue');
        const totalOrdersEl = document.getElementById('totalOrders');
        const deliveredOrdersEl = document.getElementById('deliveredOrders');
        const avgOrderValueEl = document.getElementById('avgOrderValue');
        const totalCustomersEl = document.getElementById('totalCustomers');
        const conversionRateEl = document.getElementById('conversionRate');
        const colorsContainer = document.getElementById('colorsContainer');
        const addColorBtn = document.getElementById('addColorBtn');
        const sizesContainer = document.getElementById('sizesContainer');
        const addSizeBtn = document.getElementById('addSizeBtn');
        const productDescription = document.getElementById('productDescription');
        const stockOption = document.getElementById('stockOption');
        const stockQuantityContainer = document.getElementById('stockQuantityContainer');
        const stockQuantity = document.getElementById('stockQuantity');
        const originalPrice = document.getElementById('originalPrice');
        const heroUploadArea = document.getElementById('heroUploadArea');
        const heroFileInput = document.getElementById('heroFileInput');
        const heroProgressContainer = document.getElementById('heroProgressContainer');
        const heroProgressBarFill = document.getElementById('heroProgressBarFill');
        const heroProgressText = document.getElementById('heroProgressText');
        const heroImagePreview = document.getElementById('heroImagePreview');
        const reviewForm = document.getElementById('reviewForm');
        const reviewProductName = document.getElementById('reviewProductName');
        const reviewerName = document.getElementById('reviewerName');
        const reviewRating = document.getElementById('reviewRating');
        const reviewDate = document.getElementById('reviewDate');
        const reviewText = document.getElementById('reviewText');
        const adminShippingList = document.getElementById('adminShippingList');

        function initAdminPanel() {
            // Set current date and time as default for review date
            const now = new Date();
            reviewDate.value = now.toISOString().slice(0, 16);
            
            loadData();
            setupEventListeners();
        }

        function loadData() {
            database.ref('adminPassword').on('value', (snapshot) => {
                adminPassword = snapshot.val() || "";
                if (!adminPassword) {
                    loginContainer.style.display = 'none';
                    adminPanel.style.display = 'block';
                }
            });

            database.ref('products').on('value', (snapshot) => {
                const productsData = snapshot.val();
                products = [];
                if (productsData) {
                    products = Object.keys(productsData).map(key => ({ id: key, ...productsData[key] }));
                }
                renderProductsGrid();
                updateAnalytics();
            });

            database.ref('categories').on('value', (snapshot) => {
                const categoriesData = snapshot.val();
                categories = [];
                if (categoriesData) {
                    categories = Object.keys(categoriesData).map(key => ({ id: key, name: categoriesData[key].name, image: categoriesData[key].image || 'https://via.placeholder.com/60' }));
                }
                renderCategoriesList();
                updateCategorySelect();
                updateAnalytics();
            });

            database.ref('promoCodes').on('value', (snapshot) => {
                const promoCodesData = snapshot.val();
                promoCodes = [];
                if (promoCodesData) {
                    promoCodes = Object.keys(promoCodesData).map(key => ({ id: key, code: promoCodesData[key].code, discount: promoCodesData[key].discount, active: promoCodesData[key].active !== undefined ? promoCodesData[key].active : true }));
                }
                renderPromoCodesList();
            });

            database.ref('users').on('value', (snapshot) => {
                const usersData = snapshot.val();
                users = [];
                if (usersData) {
                    users = Object.keys(usersData).map(key => ({ id: key, ...usersData[key] }));
                }
                renderUsersTable();
                updateAnalytics();
            });

            database.ref('orders').on('value', (snapshot) => {
                const ordersData = snapshot.val();
                orders = [];
                if (ordersData) {
                    orders = Object.keys(ordersData).map(key => ({ id: key, ...ordersData[key] }));
                    // Ensure all orders have a status, default to 'pending'
                    orders.forEach(order => {
                        if (!order.status) {
                            database.ref('orders/' + order.id).update({ status: 'pending' });
                        }
                    });
                }
                renderOrdersCards();
                updateAnalytics();
            });

            database.ref('reviews').on('value', (snapshot) => {
                const reviewsData = snapshot.val();
                reviews = [];
                if (reviewsData) {
                    reviews = Object.keys(reviewsData).map(key => ({ id: key, ...reviewsData[key] }));
                }
                renderReviewsCards();
                updateAnalytics();
            });

            database.ref('announcementBanner').on('value', (snapshot) => {
                const announcementData = snapshot.val();
                if (announcementData) {
                    announcement = announcementData;
                    announcementEnabled.checked = announcement.enabled;
                    announcementText.value = announcement.text || "";
                    updateAnnouncementPreview();
                }
            });

            database.ref('aboutUs').on('value', (snapshot) => {
                const aboutUsData = snapshot.val();
                if (aboutUsData) {
                    aboutUs = aboutUsData;
                    aboutUsText.value = aboutUs.text || "";
                    aboutUsContent.innerHTML = aboutUs.text || "لا يوجد محتوى حالياً";
                }
            });

            // تغيير المرجع من 'herobanner' إلى 'heroBanner'
            database.ref('heroBanner').on('value', (snapshot) => {
                const heroBannerData = snapshot.val();
                if (heroBannerData) {
                    // Handle both old string format and new object format
                    if (typeof heroBannerData === 'string') {
                        heroBanner = { imageUrl: heroBannerData };
                        // Update the database to the new format
                        database.ref('heroBanner').set(heroBanner);
                    } else {
                        heroBanner = heroBannerData;
                    }
                    renderHeroBanner();
                }
            });

            // Load shipping costs
            loadShippingCosts();
        }

        // Load shipping costs
        function loadShippingCosts() {
            database.ref('shippingCosts').once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    shippingCosts = snapshot.val();
                } else {
                    // Default shipping costs for all 27 governments
                    const defaultCosts = {};
                    egyptGovernments.forEach(gov => {
                        defaultCosts[gov] = { price: 70 };
                    });
                    shippingCosts = defaultCosts;
                    database.ref('shippingCosts').set(shippingCosts);
                }
                loadAdminShippingCosts();
            }).catch((error) => {
                console.error('Error loading shipping costs:', error);
                showNotification('خطأ في تحميل بيانات الشحن', true);
            });
        }
        
        // Load admin shipping costs
        function loadAdminShippingCosts() {
            if (!adminShippingList) return;
            
            adminShippingList.innerHTML = '';
            
            // Sort governments alphabetically for better organization
            const sortedGovernments = Object.keys(shippingCosts).sort();
            
            for (const government of sortedGovernments) {
                const form = document.createElement('div');
                form.className = 'shipping-form';
                form.innerHTML = `
                    <span>${government}</span>
                    <input type="number" class="shipping-input" value="${shippingCosts[government].price}" data-government="${government}">
                    <button class="save-shipping-btn" data-government="${government}">حفظ</button>
                `;
                adminShippingList.appendChild(form);
            }
            
            document.querySelectorAll('.save-shipping-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const government = this.getAttribute('data-government');
                    const input = document.querySelector(`.shipping-input[data-government="${government}"]`);
                    const price = parseInt(input.value);
                    
                    if (!isNaN(price)) {
                        saveShippingCost(government, price);
                    } else {
                        showNotification('يرجى إدخال سعر صحيح', true);
                    }
                });
            });
        }
        
        // Save shipping cost
        function saveShippingCost(government, price) {
            shippingCosts[government] = { price: price };
            database.ref('shippingCosts').update(shippingCosts).then(() => {
                showNotification(`تم تحديث سعر الشحن لـ ${government} إلى ${price} EGP`);
            }).catch((error) => {
                showNotification('خطأ في حفظ سعر الشحن: ' + error.message, true);
            });
        }

        function setupEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            passwordForm.addEventListener('submit', handlePasswordChange);
            aboutUsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAboutUs();
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    if (tab.dataset.tab === 'analytics') {
                        updateAnalytics();
                    }
                });
            });

            productForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveProduct();
            });

            cancelProductBtn.addEventListener('click', () => {
                resetProductForm();
            });

            categoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addCategory();
            });

            promoCodeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addPromoCode();
            });

            announcementForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAnnouncement();
            });

            announcementText.addEventListener('input', updateAnnouncementPreview);
            announcementEnabled.addEventListener('change', updateAnnouncementPreview);

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--accent-color)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--light-gray)';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--light-gray)';
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files, 'product');
                }
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFiles(fileInput.files, 'product');
                }
            });

            categoryUploadArea.addEventListener('click', () => categoryFileInput.click());
            categoryUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                categoryUploadArea.style.borderColor = 'var(--accent-color)';
            });
            categoryUploadArea.addEventListener('dragleave', () => {
                categoryUploadArea.style.borderColor = 'var(--light-gray)';
            });
            categoryUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                categoryUploadArea.style.borderColor = 'var(--light-gray)';
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files, 'category');
                }
            });

            categoryFileInput.addEventListener('change', () => {
                if (categoryFileInput.files.length > 0) {
                    handleFiles(categoryFileInput.files, 'category');
                }
            });

            heroUploadArea.addEventListener('click', () => heroFileInput.click());
            heroUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                heroUploadArea.style.borderColor = 'var(--accent-color)';
            });
            heroUploadArea.addEventListener('dragleave', () => {
                heroUploadArea.style.borderColor = 'var(--light-gray)';
            });
            heroUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                heroUploadArea.style.borderColor = 'var(--light-gray)';
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files, 'hero');
                }
            });

            heroFileInput.addEventListener('change', () => {
                if (heroFileInput.files.length > 0) {
                    handleFiles(heroFileInput.files, 'hero');
                }
            });

            downloadUsersBtn.addEventListener('click', downloadUsersCSV);

            addColorBtn.addEventListener('click', () => addColorField());
            addSizeBtn.addEventListener('click', () => addSizeField());
            stockOption.addEventListener('change', handleStockOptionChange);

            reviewForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addReview();
            });
        }

        function handleLogin() {
            const enteredPassword = passwordInput.value;
            if (!adminPassword) {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                return;
            }
            if (enteredPassword === adminPassword) {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
            } else {
                alert('كلمة المرور غير صحيحة');
            }
        }

        function handleLogout() {
            loginContainer.style.display = 'flex';
            adminPanel.style.display = 'none';
            passwordInput.value = '';
        }

        function handlePasswordChange(e) {
            e.preventDefault();
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                alert('كلمتا المرور غير متطابقتين');
                return;
            }

            if (newPassword) {
                database.ref('adminPassword').set(newPassword)
                    .then(() => {
                        alert('تم تحديث كلمة المرور بنجاح');
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                    })
                    .catch(error => alert('خطأ في تحديث كلمة المرور: ' + error.message));
            } else {
                alert('يرجى إدخال كلمة مرور جديدة');
            }
        }

        function saveAboutUs() {
            const text = aboutUsText.value.trim();
            database.ref('aboutUs').set({ text: text })
                .then(() => {
                    alert('تم حفظ معلومات المتجر بنجاح!');
                    aboutUsContent.innerHTML = text || "لا يوجد محتوى حالياً";
                })
                .catch(error => alert('خطأ في حفظ المعلومات: ' + error.message));
        }

        function handleStockOptionChange() {
            const value = stockOption.value;
            if (value === 'quantity') {
                stockQuantityContainer.classList.add('visible');
            } else {
                stockQuantityContainer.classList.remove('visible');
            }
        }

        function addColorField(colorName = '') {
            const colorField = document.createElement('div');
            colorField.className = 'dynamic-field-container';
            colorField.innerHTML = `
                <div class="dynamic-field-row">
                    <input type="text" placeholder="اسم اللون" value="${colorName}" class="color-name">
                    <button type="button" class="remove-field-btn">&times;</button>
                </div>
            `;
            colorsContainer.appendChild(colorField);
            colorField.querySelector('.remove-field-btn').addEventListener('click', () => {
                colorField.remove();
            });
        }

        function addSizeField(size = '') {
            const sizeField = document.createElement('div');
            sizeField.className = 'dynamic-field-container';
            sizeField.innerHTML = `
                <div class="dynamic-field-row">
                    <input type="text" placeholder="المقاس" value="${size}" class="size-value">
                    <button type="button" class="remove-field-btn">&times;</button>
                </div>
            `;
            sizesContainer.appendChild(sizeField);
            sizeField.querySelector('.remove-field-btn').addEventListener('click', () => {
                sizeField.remove();
            });
        }

        function updateAnnouncementPreview() {
            if (announcementEnabled.checked && announcementText.value) {
                announcementPreview.style.display = 'block';
                previewText.textContent = announcementText.value;
            } else {
                announcementPreview.style.display = 'none';
            }
        }

        function saveAnnouncement() {
            const announcementData = {
                enabled: announcementEnabled.checked,
                text: announcementText.value
            };
            database.ref('announcementBanner').set(announcementData)
                .then(() => alert('تم حفظ إعدادات الإعلان بنجاح!'))
                .catch(error => alert('خطأ في حفظ الإعلان: ' + error.message));
        }

        function resetProductForm() {
            productForm.reset();
            document.getElementById('productId').value = '';
            imagePreview.innerHTML = '';
            uploadedImages = [];
            productImageUrls.value = '';
            progressContainer.style.display = 'none';
            colorsContainer.innerHTML = '';
            sizesContainer.innerHTML = '';
            productDescription.value = '';
            stockQuantityContainer.classList.remove('visible');
            stockOption.value = 'none';
            originalPrice.value = '';
        }

        function handleFiles(files, type) {
            if (type === 'product') {
                progressContainer.style.display = 'block';
                progressBarFill.style.width = '0%';
                progressText.textContent = '0%';
            } else if (type === 'category') {
                categoryProgressContainer.style.display = 'block';
                categoryProgressBarFill.style.width = '0%';
                categoryImagePreview.innerHTML = '';
                uploadedCategoryImage = null;
            } else if (type === 'hero') {
                heroProgressContainer.style.display = 'block';
                heroProgressBarFill.style.width = '0%';
                heroProgressText.textContent = '0%';
            }

            const totalFiles = files.length;
            let processedFiles = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) {
                    processedFiles++;
                    updateProgress(processedFiles, totalFiles, type);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    const formData = new FormData();
                    formData.append('image', imageData.split(',')[1]);

                    fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (type === 'product') {
                                uploadedImages.push(data.data.url);
                                addImagePreview(data.data.url, type);
                                productImageUrls.value = JSON.stringify(uploadedImages);
                            } else if (type === 'category') {
                                uploadedCategoryImage = data.data.url;
                                addImagePreview(data.data.url, type);
                                categoryImageUrl.value = uploadedCategoryImage;
                            } else if (type === 'hero') {
                                saveHeroBanner(data.data.url);
                            }
                        }
                        processedFiles++;
                        updateProgress(processedFiles, totalFiles, type);
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        processedFiles++;
                        updateProgress(processedFiles, totalFiles, type);
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function updateProgress(processed, total, type) {
            const progress = Math.round((processed / total) * 100);
            if (type === 'product') {
                progressBarFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
                if (processed === total) {
                    setTimeout(() => progressContainer.style.display = 'none', 1000);
                }
            } else if (type === 'category') {
                categoryProgressBarFill.style.width = `${progress}%`;
                if (processed === total) {
                    setTimeout(() => categoryProgressContainer.style.display = 'none', 1000);
                }
            } else if (type === 'hero') {
                heroProgressBarFill.style.width = `${progress}%`;
                heroProgressText.textContent = `${progress}%`;
                if (processed === total) {
                    setTimeout(() => heroProgressContainer.style.display = 'none', 1000);
                }
            }
        }

        function addImagePreview(url, type) {
            if (type === 'product') {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${url}" alt="Preview">
                    <button class="remove-image" data-url="${url}">&times;</button>
                `;
                previewItem.querySelector('.remove-image').addEventListener('click', (e) => {
                    e.preventDefault();
                    removeImage(url, type);
                    previewItem.remove();
                });
                imagePreview.appendChild(previewItem);
            } else if (type === 'category') {
                categoryImagePreview.innerHTML = `
                    <div class="image-preview-item">
                        <img src="${url}" alt="Category Preview">
                        <button class="remove-image" id="removeCategoryImage">&times;</button>
                    </div>
                `;
                document.getElementById('removeCategoryImage').addEventListener('click', (e) => {
                    e.preventDefault();
                    removeImage(url, type);
                    categoryImagePreview.innerHTML = '';
                });
            }
        }

        function removeImage(url, type) {
            if (type === 'product') {
                uploadedImages = uploadedImages.filter(imgUrl => imgUrl !== url);
                productImageUrls.value = JSON.stringify(uploadedImages);
            } else if (type === 'category') {
                uploadedCategoryImage = null;
                categoryImageUrl.value = '';
            }
        }

        function saveHeroBanner(url) {
            const heroBannerData = { imageUrl: url };
            // تغيير المرجع من 'herobanner' إلى 'heroBanner'
            database.ref('heroBanner').set(heroBannerData)
                .then(() => {
                    alert('تم حفظ اللافتة الرئيسية بنجاح!');
                    heroBanner = heroBannerData;
                    renderHeroBanner();
                })
                .catch(error => alert('خطأ في حفظ اللافتة الرئيسية: ' + error.message));
        }

        function renderHeroBanner() {
            if (heroBanner) {
                const url = heroBanner.imageUrl;
                heroImagePreview.innerHTML = `
                    <div class="image-preview-item" style="width: 100%; max-width: 500px;">
                        <img src="${url}" alt="Hero Banner" style="width: 100%; height: auto;">
                    </div>
                `;
            } else {
                heroImagePreview.innerHTML = '';
            }
        }

        function renderProductsGrid() {
            productsGrid.innerHTML = products.map(product => {
                let stockStatus = '';
                let stockBadge = '';
                if (product.stock === undefined) {
                    stockStatus = 'غير محدد';
                } else if (product.stock === 0) {
                    stockStatus = 'تم البيع';
                    stockBadge = '<span class="status-badge sold-out">تم البيع</span>';
                } else {
                    stockStatus = `${product.stock} متاح`;
                    stockBadge = `<span class="status-badge in-stock">${product.stock} متاح</span>`;
                }

                let priceHtml = `<div class="product-card-price">${product.price} ج.م</div>`;
                if (product.originalPrice && product.originalPrice > product.price) {
                    const discountPercentage = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                    priceHtml = `
                        <div class="product-card-price">
                            <span class="product-card-old-price">${product.originalPrice} ج.م</span>
                            ${product.price} ج.م
                        </div>
                        <div class="product-card-discount">خصم ${discountPercentage}%</div>
                    `;
                }

                return `
                    <div class="product-card">
                        <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/300'}" alt="${product.name}" class="product-card-img">
                        <div class="product-card-body">
                            <h3 class="product-card-title">${product.name}</h3>
                            <div class="product-card-category">${product.category}</div>
                            ${priceHtml}
                            <div>${stockBadge}</div>
                            <div class="product-card-description">${product.description || ''}</div>
                        </div>
                        <div class="product-card-footer">
                            <button class="btn btn-primary edit-btn" data-id="${product.id}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-secondary delete-btn" data-id="${product.id}"><i class="fas fa-trash"></i> حذف</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    editProduct(productId);
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.querySelector('.tab[data-tab="products"]').classList.add('active');
                    document.getElementById('products-tab').classList.add('active');
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    if (confirm('هل أنت متأكد أنك تريد حذف هذا المنتج؟')) {
                        deleteProduct(productId);
                    }
                });
            });
        }

        function renderCategoriesList() {
            categoriesList.innerHTML = categories.map(category => `
                <div class="category-card">
                    <div class="category-info">
                        <img src="${category.image}" alt="${category.name}" class="category-image">
                        <span>${category.name}</span>
                    </div>
                    <div class="category-actions">
                        <button class="action-btn edit-btn" data-id="${category.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" data-id="${category.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.category-card .edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const categoryId = btn.dataset.id;
                    editCategory(categoryId);
                });
            });

            document.querySelectorAll('.category-card .delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const categoryId = btn.dataset.id;
                    if (confirm('هل أنت متأكد أنك تريد حذف هذه الفئة؟')) {
                        deleteCategory(categoryId);
                    }
                });
            });
        }

        function renderPromoCodesList() {
            promoCodesList.innerHTML = promoCodes.map(promo => `
                <div class="promo-card">
                    <div class="promo-info">
                        <div class="promo-code">${promo.code}</div>
                        <div class="promo-value">خصم ${promo.discount} ج.م</div>
                        <span class="promo-active-badge active-${promo.active}">${promo.active ? 'نشط' : 'غير نشط'}</span>
                    </div>
                    <div class="promo-actions">
                        <button class="action-btn edit-btn" data-id="${promo.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" data-id="${promo.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.promo-card .edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const promoId = btn.dataset.id;
                    editPromoCode(promoId);
                });
            });

            document.querySelectorAll('.promo-card .delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const promoId = btn.dataset.id;
                    if (confirm('هل أنت متأكد أنك تريد حذف رمز التخفيض هذا؟')) {
                        deletePromoCode(promoId);
                    }
                });
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'غير متوفر';
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG');
        }

        function formatDateOnly(timestamp) {
            if (!timestamp) return 'غير متوفر';
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG');
        }

        function renderOrdersCards() {
            ordersContainer.innerHTML = orders.map(order => {
                // Set default status to 'pending' if not set
                const orderStatus = order.status || 'pending';
                
                let statusClass = '';
                switch (orderStatus) {
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'processing': statusClass = 'status-processing'; break;
                    case 'shipped': statusClass = 'status-shipped'; break;
                    case 'delivered': statusClass = 'status-delivered'; break;
                    case 'cancelled': statusClass = 'status-cancelled'; break;
                    default: statusClass = 'status-pending';
                }

                let statusText = '';
                switch (orderStatus) {
                    case 'pending': statusText = 'قيد الانتظار'; break;
                    case 'processing': statusText = 'قيد المعالجة'; break;
                    case 'shipped': statusText = 'تم الشحن'; break;
                    case 'delivered': statusText = 'تم التسليم'; break;
                    case 'cancelled': statusText = 'ملغي'; break;
                    default: statusText = orderStatus;
                }

                // الحصول على معلومات العميل بشكل صحيح
                const customerName = order.customer?.name || order.name || 'غير متوفر';
                const customerPhone = order.customer?.phone || order.phone || 'غير متوفر';
                const customerPhone2 = order.customer?.phone2 || order.phone2 || '';
                const customerAddress = order.customer?.address || order.address || 'غير متوفر';
                const customerFloor = order.customer?.floor || order.floor || 'غير متوفر';
                const customerGovernment = order.customer?.government || order.government || 'غير متوفر';
                const customerNotes = order.customer?.notes || order.notes || 'لا يوجد ملاحظات';

                // الحصول على قيمة الشحن من Firebase
                const shippingValue = order.shipping || 0;
                
                // حساب المجموع الفرعي (مجموع أسعار المنتجات قبل التخفيض)
                let subtotal = 0;
                if (order.items) {
                    order.items.forEach(item => {
                        // استخدام السعر الأصلي للمنتج إذا كان متوفراً، وإلا استخدام السعر الحالي
                        const itemPrice = item.originalPrice || item.price;
                        subtotal += itemPrice * item.quantity;
                    });
                }
                
                // حساب الخصم
                const discount = order.discount || 0;
                
                // حساب المجموع بعد الخصم
                const totalAfterDiscount = Math.max(0, subtotal - discount);
                
                // استخدام المجموع النهائي من Firebase إذا كان متوفراً
                const finalTotal = order.total || order.finalTotal || order.amount || (totalAfterDiscount + shippingValue);

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">طلب #${order.id.substring(0, 8)}</div>
                            <div class="order-date">${formatDate(order.createdAt)}</div>
                        </div>
                        <div class="order-customer">
                            <div class="customer-name">${customerName}</div>
                            <div class="customer-details">
                                ${customerPhone}${customerPhone2 ? ' • ' + customerPhone2 : ''}
                                <br>${customerAddress}
                            </div>
                        </div>
                        <div class="order-products">
                            ${order.items ? order.items.map(item => {
                                const itemPrice = item.originalPrice || item.price;
                                const itemTotal = itemPrice * item.quantity;
                                const currentPrice = item.price;
                                
                                return `
                                <div class="product-item">
                                    <img src="${item.image || 'https://via.placeholder.com/50'}" alt="${item.name}" class="product-item-img">
                                    <div class="product-item-details">
                                        <div class="product-item-name">${item.name}</div>
                                        ${item.size ? `<div class="product-item-size">المقاس: ${item.size}</div>` : ''}
                                        ${item.color ? `<div class="product-item-color">اللون: ${item.color}</div>` : ''}
                                        <div class="product-item-price">
                                            ${item.originalPrice && item.originalPrice > item.price ? 
                                                `<span style="text-decoration: line-through; color: #999; margin-left: 5px;">${item.originalPrice} ج.م</span>` : ''}
                                            ${currentPrice} ج.م x ${item.quantity}
                                        </div>
                                    </div>
                                    <div class="product-item-quantity">${itemTotal} ج.م</div>
                                </div>
                                `;
                            }).join('') : ''}
                        </div>
                        <div class="order-summary">
                            <div>المجموع الفرعي:</div>
                            <div>${subtotal} ج.م</div>
                        </div>
                        <div class="order-summary">
                            <div>الخصم:</div>
                            <div>${discount} ج.م</div>
                        </div>
                        <div class="order-summary">
                            <div>المجموع بعد الخصم:</div>
                            <div>${totalAfterDiscount} ج.م</div>
                        </div>
                        <div class="order-summary">
                            <div>الشحن:</div>
                            <div>${shippingValue} ج.م</div>
                        </div>
                        <div class="order-summary">
                            <div class="order-total">المجموع النهائي:</div>
                            <div class="order-total">${finalTotal} ج.م</div>
                        </div>
                        <div class="order-status">
                            <div><span class="status-badge ${statusClass}">${statusText}</span></div>
                            <div class="order-actions">
                                ${orderStatus !== 'cancelled' ? `
                                    <select class="status-select" data-order-id="${order.id}">
                                        <option value="pending" ${orderStatus === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                                        <option value="processing" ${orderStatus === 'processing' ? 'selected' : ''}>قيد المعالجة</option>
                                        <option value="shipped" ${orderStatus === 'shipped' ? 'selected' : ''}>تم الشحن</option>
                                        <option value="delivered" ${orderStatus === 'delivered' ? 'selected' : ''}>تم التسليم</option>
                                        <option value="cancelled">إلغاء الطلب</option>
                                    </select>
                                ` : ''}
                                <button class="delete-order-btn" data-order-id="${order.id}">
                                    <i class="fas fa-trash"></i> حذف الطلب
                                </button>
                            </div>
                        </div>
                        <button class="customer-data-toggle" data-order-id="${order.id}">
                            <i class="fas fa-chevron-down"></i> بيانات العميل
                        </button>
                        <div class="customer-data-content" id="customer-data-${order.id}">
                            <div class="detail-row">
                                <div class="detail-label">اسم العميل:</div>
                                <div class="detail-value">${customerName}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">رقم الهاتف:</div>
                                <div class="detail-value">${customerPhone}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">رقم هاتف إضافي:</div>
                                <div class="detail-value">${customerPhone2 || 'لا يوجد'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الملاحظات:</div>
                                <div class="detail-value">${customerNotes}</div>
                            </div>
                        </div>
                        <button class="order-details-toggle" data-order-id="${order.id}">
                            <i class="fas fa-chevron-down"></i> عرض تفاصيل الطلب
                        </button>
                        <div class="order-details-content" id="details-${order.id}">
                            <div class="detail-row">
                                <div class="detail-label">رقم الطلب:</div>
                                <div class="detail-value">${order.id}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">اسم العميل:</div>
                                <div class="detail-value">${customerName}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">تاريخ الطلب:</div>
                                <div class="detail-value">${formatDate(order.createdAt)}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">العنوان:</div>
                                <div class="detail-value">${customerAddress}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الدور:</div>
                                <div class="detail-value">${customerFloor}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">المحافظة:</div>
                                <div class="detail-value">${customerGovernment}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الملاحظات:</div>
                                <div class="detail-value">${customerNotes}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الهاتف:</div>
                                <div class="detail-value">${customerPhone}${customerPhone2 ? '<br>' + customerPhone2 : ''}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">المنتجات:</div>
                                <div class="detail-value">
                                    ${order.items ? order.items.map(item => {
                                        const itemPrice = item.originalPrice || item.price;
                                        const itemTotal = itemPrice * item.quantity;
                                        
                                        return `
                                        <div>${item.name}${item.size ? ` - المقاس: ${item.size}` : ''}${item.color ? ` - اللون: ${item.color}` : ''} - ${item.quantity} x ${itemPrice} ج.م = ${itemTotal} ج.م</div>
                                        `;
                                    }).join('') : 'غير متوفر'}
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">المجموع الفرعي:</div>
                                <div class="detail-value">${subtotal} ج.م</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الخصم:</div>
                                <div class="detail-value">${discount} ج.م</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">المجموع بعد الخصم:</div>
                                <div class="detail-value">${totalAfterDiscount} ج.م</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">الشحن:</div>
                                <div class="detail-value">${shippingValue} ج.م</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">المجموع النهائي:</div>
                                <div class="detail-value">${finalTotal} ج.م</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const orderId = e.target.dataset.orderId;
                    const newStatus = e.target.value;
                    if (newStatus === 'cancelled') {
                        if (confirm('هل أنت متأكد أنك تريد إلغاء هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.')) {
                            updateOrderStatus(orderId, newStatus);
                        } else {
                            const order = orders.find(o => o.id === orderId);
                            e.target.value = order.status || 'pending';
                        }
                    } else {
                        if (confirm(`هل أنت متأكد أنك تريد تغيير حالة الطلب إلى ${newStatus}؟`)) {
                            updateOrderStatus(orderId, newStatus);
                        } else {
                            const order = orders.find(o => o.id === orderId);
                            e.target.value = order.status || 'pending';
                        }
                    }
                });
            });

            document.querySelectorAll('.order-details-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const orderId = toggle.dataset.orderId;
                    const detailsContent = document.getElementById(`details-${orderId}`);
                    const icon = toggle.querySelector('i');
                    if (detailsContent.classList.contains('show')) {
                        detailsContent.classList.remove('show');
                        icon.className = 'fas fa-chevron-down';
                        toggle.innerHTML = `<i class="fas fa-chevron-down"></i> عرض تفاصيل الطلب`;
                    } else {
                        detailsContent.classList.add('show');
                        icon.className = 'fas fa-chevron-up';
                        toggle.innerHTML = `<i class="fas fa-chevron-up"></i> إخفاء تفاصيل الطلب`;
                    }
                });
            });

            document.querySelectorAll('.customer-data-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const orderId = toggle.dataset.orderId;
                    const customerDataContent = document.getElementById(`customer-data-${orderId}`);
                    const icon = toggle.querySelector('i');
                    if (customerDataContent.classList.contains('show')) {
                        customerDataContent.classList.remove('show');
                        icon.className = 'fas fa-chevron-down';
                        toggle.innerHTML = `<i class="fas fa-chevron-down"></i> بيانات العميل`;
                    } else {
                        customerDataContent.classList.add('show');
                        icon.className = 'fas fa-chevron-up';
                        toggle.innerHTML = `<i class="fas fa-chevron-up"></i> إخفاء بيانات العميل`;
                    }
                });
            });

            // Add event listeners for delete order buttons
            document.querySelectorAll('.delete-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.dataset.orderId;
                    if (confirm('هل أنت متأكد أنك تريد حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.')) {
                        deleteOrder(orderId);
                    }
                });
            });
        }

        function deleteOrder(orderId) {
            database.ref('orders/' + orderId).remove()
                .then(() => {
                    alert('تم حذف الطلب بنجاح!');
                    showNotification('تم حذف الطلب بنجاح!');
                })
                .catch(error => {
                    alert('خطأ في حذف الطلب: ' + error.message);
                    showNotification('خطأ في حذف الطلب: ' + error.message, true);
                });
        }

        function renderReviewsCards() {
            reviewCardsContainer.innerHTML = reviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                
                // الحصول على اسم المقيّم بشكل صحيح
                let reviewerName = 'مجهول';
                if (review.userName) {
                    reviewerName = review.userName;
                } else if (review.user && review.user.name) {
                    reviewerName = review.user.name;
                } else if (review.userId) {
                    reviewerName = `مستخدم ${review.userId.substring(0, 8)}`;
                }

                // الحصول على اسم المنتج بشكل صحيح
                let productName = 'منتج غير معروف';
                if (review.productName) {
                    productName = review.productName;
                } else if (review.product && review.product.name) {
                    productName = review.product.name;
                } else if (review.productId) {
                    const product = products.find(p => p.id === review.productId);
                    productName = product ? product.name : `منتج ${review.productId.substring(0, 8)}`;
                }

                // البحث عن المنتج للحصول على صورته
                let productImage = 'https://via.placeholder.com/60';
                const product = products.find(p => p.name === productName);
                if (product && product.images && product.images.length > 0) {
                    productImage = product.images[0];
                }

                return `
                    <div class="review-card">
                        <div class="review-card-header">
                            <img src="${productImage}" alt="${productName}" class="review-product-image">
                            <div class="review-product-info">
                                <div class="review-product-name">${productName}</div>
                                <div class="review-rating-stars">${stars} (${review.rating}/5)</div>
                                <div class="reviewer-name">${reviewerName}</div>
                            </div>
                        </div>
                        <div class="review-comment">${review.text || 'لم يتم تقديم تعليق.'}</div>
                        <div class="review-footer">
                            <div class="review-date">${formatDate(review.timestamp || review.createdAt)}</div>
                            <div class="review-actions">
                                <button class="review-details-toggle" data-review-id="${review.id}">
                                    <i class="fas fa-chevron-down"></i> تفاصيل
                                </button>
                                <button class="action-btn delete-btn" data-id="${review.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="review-details-content" id="review-details-${review.id}">
                            <div class="detail-row">
                                <div class="detail-label">معرف التقييم:</div>
                                <div class="detail-value">${review.id}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">معرف المنتج:</div>
                                <div class="detail-value">${review.productId || 'غير متوفر'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">معرف المستخدم:</div>
                                <div class="detail-value">${review.userId || 'غير متوفر'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">التقييم:</div>
                                <div class="detail-value">${review.rating} / 5</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">نص التقييم:</div>
                                <div class="detail-value">${review.text || 'لا يوجد نص'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">تاريخ الإنشاء:</div>
                                <div class="detail-value">${formatDate(review.createdAt || review.timestamp)}</div>
                            </div>
                            ${review.verifiedPurchase ? `
                                <div class="detail-row">
                                    <div class="detail-label">تم الشراء:</div>
                                    <div class="detail-value">نعم</div>
                                </div>
                            ` : ''}
                            ${review.helpful ? `
                                <div class="detail-row">
                                    <div class="detail-label">مفيد:</div>
                                    <div class="detail-value">${review.helpful}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.review-details-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const reviewId = toggle.dataset.reviewId;
                    const detailsContent = document.getElementById(`review-details-${reviewId}`);
                    const icon = toggle.querySelector('i');
                    if (detailsContent.classList.contains('show')) {
                        detailsContent.classList.remove('show');
                        icon.className = 'fas fa-chevron-down';
                        toggle.innerHTML = `<i class="fas fa-chevron-down"></i> تفاصيل`;
                    } else {
                        detailsContent.classList.add('show');
                        icon.className = 'fas fa-chevron-up';
                        toggle.innerHTML = `<i class="fas fa-chevron-up"></i> إخفاء التفاصيل`;
                    }
                });
            });

            document.querySelectorAll('.review-card .delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const reviewId = btn.dataset.id;
                    if (confirm('هل أنت متأكد أنك تريد حذف هذا التقييم؟')) {
                        deleteReview(reviewId);
                    }
                });
            });
        }

        function addReview() {
            const productName = reviewProductName.value.trim();
            const reviewer = reviewerName.value.trim();
            const rating = parseInt(reviewRating.value);
            const text = reviewText.value.trim();
            const date = new Date(reviewDate.value).getTime();

            if (!productName || !reviewer || !rating || !date) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            const newReviewRef = database.ref('reviews').push();
            const reviewData = {
                id: newReviewRef.key,
                productName: productName,
                userName: reviewer,
                rating: rating,
                text: text,
                timestamp: date,
                createdAt: date
            };

            newReviewRef.set(reviewData)
                .then(() => {
                    alert('تمت إضافة التقييم بنجاح!');
                    reviewForm.reset();
                    // Reset date to current time
                    const now = new Date();
                    reviewDate.value = now.toISOString().slice(0, 16);
                })
                .catch(error => alert('خطأ في إضافة التقييم: ' + error.message));
        }

        function renderUsersTable() {
            usersTableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'غير متوفر'}</td>
                    <td>${user.email || 'غير متوفر'}</td>
                    <td>${user.phone || 'غير متوفر'}</td>
                    <td>${user.registrationDate || 'غير متوفر'}</td>
                </tr>
            `).join('');
        }

        function downloadUsersCSV() {
            if (users.length === 0) {
                alert('لا يوجد مستخدمين للتنزيل');
                return;
            }

            let csvContent = 'Name,Email,Phone,Registration Date\n';
            users.forEach(user => {
                const row = [
                    user.name || '',
                    user.email || '',
                    user.phone || '',
                    user.registrationDate || ''
                ].map(field => `"${field.replace(/"/g, '""')}"`).join(',');
                csvContent += row + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'users.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateCategorySelect() {
            productCategorySelect.innerHTML = `<option value="">اختر فئة</option>${categories.map(category => `<option value="${category.name}">${category.name}</option>`).join('')}`;
        }

        function updateAnalytics() {
            // FIXED: Better handling of order totals with fallback options
            const deliveredOrders = orders.filter(order => order.status === 'delivered');
            
            // Calculate total revenue with fallback for different field names
            const totalRevenue = deliveredOrders.reduce((sum, order) => {
                // Try different field names for total amount
                const orderTotal = order.total || order.finalTotal || order.amount || 0;
                return sum + orderTotal;
            }, 0);
            
            const totalOrdersCount = orders.length;
            const deliveredOrdersCount = deliveredOrders.length;
            const avgOrderValue = deliveredOrdersCount > 0 ? totalRevenue / deliveredOrdersCount : 0;

            // Count unique customers by phone number
            const customerPhones = new Set();
            orders.forEach(order => {
                if (order.customer && order.customer.phone) {
                    customerPhones.add(order.customer.phone);
                } else if (order.phone) {
                    customerPhones.add(order.phone);
                }
            });
            const totalCustomers = customerPhones.size;

            // Simple conversion rate calculation
            const conversionRate = totalCustomers > 0 ? Math.min(100, Math.round((totalOrdersCount / (totalCustomers * 3)) * 100)) : 0;

            totalRevenueEl.textContent = `${totalRevenue.toFixed(2)} ج.م`;
            totalOrdersEl.textContent = totalOrdersCount;
            deliveredOrdersEl.textContent = deliveredOrdersCount;
            avgOrderValueEl.textContent = `${avgOrderValue.toFixed(2)} ج.م`;
            totalCustomersEl.textContent = totalCustomers;
            conversionRateEl.textContent = `${conversionRate}%`;

            updateOrdersStatusChart();
            updateRevenueChart();
            updateTopProductsChart();
            updateCategoryChart();
            updateCustomerChart();
            updateRatingsChart();
        }

        function updateOrdersStatusChart() {
            const statusCounts = { 'pending': 0, 'processing': 0, 'shipped': 0, 'delivered': 0, 'cancelled': 0 };
            orders.forEach(order => {
                const status = order.status || 'pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const ctx = document.getElementById('ordersStatusChart').getContext('2d');
            if (ordersStatusChart) ordersStatusChart.destroy();
            ordersStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['قيد الانتظار', 'قيد المعالجة', 'تم الشحن', 'تم التسليم', 'ملغي'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts.processing, statusCounts.shipped, statusCounts.delivered, statusCounts.cancelled],
                        backgroundColor: ['#fff3cd', '#e3f2fd', '#d1ecf1', '#e8f5e9', '#ffebee'],
                        borderColor: ['#856404', '#1976d2', '#0c5460', '#2e7d32', '#c62828'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateRevenueChart() {
            // FIXED: Better handling of order totals with fallback options
            const deliveredOrders = orders.filter(order => order.status === 'delivered');
            const revenueByMonth = {};
            
            deliveredOrders.forEach(order => {
                if (order.createdAt) {
                    const date = new Date(order.createdAt);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    if (!revenueByMonth[monthYear]) revenueByMonth[monthYear] = 0;
                    
                    // Try different field names for total amount
                    const orderTotal = order.total || order.finalTotal || order.amount || 0;
                    revenueByMonth[monthYear] += orderTotal;
                }
            });

            const sortedMonths = Object.keys(revenueByMonth).sort();
            const monthlyRevenue = sortedMonths.map(month => revenueByMonth[month]);
            const monthLabels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleString('ar-EG', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'الإيرادات (ج.م)',
                        data: monthlyRevenue,
                        backgroundColor: '#25D366',
                        borderColor: '#1da84e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value + ' ج.م'
                            }
                        }
                    }
                }
            });
        }

        function updateTopProductsChart() {
            // FIXED: Better handling of order totals and product matching
            const deliveredOrders = orders.filter(order => order.status === 'delivered');
            const productSales = {};
            
            deliveredOrders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        if (!productSales[item.name]) {
                            productSales[item.name] = {
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        productSales[item.name].quantity += item.quantity;
                        productSales[item.name].revenue += (item.price * item.quantity);
                    });
                }
            });

            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .slice(0, 10);
                
            const productNames = sortedProducts.map(item => item[0]);
            const salesCounts = sortedProducts.map(item => item[1].quantity);

            const ctx = document.getElementById('topProductsChart').getContext('2d');
            if (topProductsChart) topProductsChart.destroy();
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'الوحدات المباعة',
                        data: salesCounts,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            // FIXED: Better handling of category matching
            const deliveredOrders = orders.filter(order => order.status === 'delivered');
            const categoryRevenue = {};
            
            deliveredOrders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        // Find the product to get its category
                        const product = products.find(p => p.name === item.name);
                        if (product) {
                            const categoryName = product.category || 'غير مصنف';
                            if (!categoryRevenue[categoryName]) categoryRevenue[categoryName] = 0;
                            categoryRevenue[categoryName] += (item.price * item.quantity);
                        } else {
                            // If product not found, use a default category
                            const categoryName = 'غير مصنف';
                            if (!categoryRevenue[categoryName]) categoryRevenue[categoryName] = 0;
                            categoryRevenue[categoryName] += (item.price * item.quantity);
                        }
                    });
                }
            });

            const categoryNames = Object.keys(categoryRevenue);
            const revenueValues = Object.values(categoryRevenue);

            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryNames,
                    datasets: [{
                        data: revenueValues,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value.toFixed(2)} ج.م (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCustomerChart() {
            const customersByMonth = {};
            users.forEach(user => {
                if (user.registrationDate) {
                    const date = new Date(user.registrationDate);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    if (!customersByMonth[monthYear]) customersByMonth[monthYear] = 0;
                    customersByMonth[monthYear] += 1;
                }
            });

            const sortedMonths = Object.keys(customersByMonth).sort();
            const monthlyCustomers = sortedMonths.map(month => customersByMonth[month]);
            const monthLabels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleString('ar-EG', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('customerChart').getContext('2d');
            if (customerChart) customerChart.destroy();
            customerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'عملاء جدد',
                        data: monthlyCustomers,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateRatingsChart() {
            const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            reviews.forEach(review => {
                const rating = Math.round(review.rating);
                if (rating >= 1 && rating <= 5) ratingCounts[rating] = (ratingCounts[rating] || 0) + 1;
            });

            const ratingValues = [ratingCounts[1], ratingCounts[2], ratingCounts[3], ratingCounts[4], ratingCounts[5]];

            const ctx = document.getElementById('ratingsChart').getContext('2d');
            if (ratingsChart) ratingsChart.destroy();
            ratingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['نجمة واحدة', 'نجمتان', '3 نجوم', '4 نجوم', '5 نجوم'],
                    datasets: [{
                        label: 'عدد التقييمات',
                        data: ratingValues,
                        backgroundColor: ['#FF6384', '#FF9F40', '#FFCE56', '#4BC0C0', '#36A2EB'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const productName = document.getElementById('productName').value;
            const productPrice = parseFloat(document.getElementById('productPrice').value);
            const originalPriceValue = parseFloat(document.getElementById('originalPrice').value) || null;
            const productCategory = document.getElementById('productCategory').value;
            const description = document.getElementById('productDescription').value;
            const images = uploadedImages;

            const colorElements = colorsContainer.querySelectorAll('.dynamic-field-container');
            const colors = [];
            colorElements.forEach(colorElement => {
                const name = colorElement.querySelector('.color-name').value;
                if (name) colors.push(name);
            });

            const sizeElements = sizesContainer.querySelectorAll('.dynamic-field-container');
            const sizes = [];
            sizeElements.forEach(sizeElement => {
                const size = sizeElement.querySelector('.size-value').value;
                if (size) sizes.push(size);
            });

            const stockOptionValue = document.getElementById('stockOption').value;
            let stockValue = undefined;
            if (stockOptionValue === 'quantity') {
                stockValue = parseInt(document.getElementById('stockQuantity').value) || 0;
            } else if (stockOptionValue === 'soldout') {
                stockValue = 0;
            }

            if (!productName || !productPrice || !productCategory || !images || images.length === 0) {
                alert('يرجى ملء جميع الحقول المطلوبة ورفع صورة واحدة على الأقل');
                return;
            }

            const productData = {
                name: productName,
                price: productPrice,
                category: productCategory,
                description: description,
                colors: colors,
                sizes: sizes,
                images: images
            };

            if (originalPriceValue) {
                productData.originalPrice = originalPriceValue;
            }

            if (stockValue !== undefined) {
                productData.stock = stockValue;
            }

            if (productId) {
                database.ref('products/' + productId).update(productData)
                    .then(() => {
                        alert('تم تحديث المنتج بنجاح!');
                        resetProductForm();
                    })
                    .catch(error => alert('خطأ في تحديث المنتج: ' + error.message));
            } else {
                const newProductRef = database.ref('products').push();
                productData.id = newProductRef.key;
                newProductRef.set(productData)
                    .then(() => {
                        alert('تمت إضافة المنتج بنجاح!');
                        resetProductForm();
                    })
                    .catch(error => alert('خطأ في إضافة المنتج: ' + error.message));
            }
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('originalPrice').value = product.originalPrice || '';

            imagePreview.innerHTML = '';
            uploadedImages = product.images || [];
            if (product.images && product.images.length > 0) {
                product.images.forEach(image => addImagePreview(image, 'product'));
            }

            if (product.stock === undefined) {
                document.getElementById('stockOption').value = 'none';
                document.getElementById('stockQuantityContainer').classList.remove('visible');
            } else if (product.stock === 0) {
                document.getElementById('stockOption').value = 'soldout';
                document.getElementById('stockQuantityContainer').classList.remove('visible');
            } else {
                document.getElementById('stockOption').value = 'quantity';
                document.getElementById('stockQuantity').value = product.stock;
                document.getElementById('stockQuantityContainer').classList.add('visible');
            }

            colorsContainer.innerHTML = '';
            if (product.colors && product.colors.length > 0) {
                product.colors.forEach(color => {
                    if (typeof color === 'object') {
                        addColorField(color.name);
                    } else {
                        addColorField(color);
                    }
                });
            } else {
                addColorField();
            }

            sizesContainer.innerHTML = '';
            if (product.sizes && product.sizes.length > 0) {
                product.sizes.forEach(size => addSizeField(size));
            } else {
                addSizeField();
            }
        }

        function deleteProduct(productId) {
            database.ref('products/' + productId).remove()
                .then(() => alert('تم حذف المنتج بنجاح!'))
                .catch(error => alert('خطأ في حذف المنتج: ' + error.message));
        }

        function addCategory() {
            const categoryName = document.getElementById('categoryName').value.trim();
            const categoryImage = uploadedCategoryImage;

            if (!categoryName) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }

            if (!categoryImage) {
                alert('يرجى رفع صورة للفئة');
                return;
            }

            if (categories.some(c => c.name.toLowerCase() === categoryName.toLowerCase())) {
                alert('الفئة موجودة بالفعل');
                return;
            }

            const newCategoryRef = database.ref('categories').push();
            const categoryData = {
                id: newCategoryRef.key,
                name: categoryName,
                image: categoryImage
            };

            newCategoryRef.set({ name: categoryName, image: categoryImage })
                .then(() => {
                    alert('تمت إضافة الفئة بنجاح!');
                    categoryForm.reset();
                    categoryImagePreview.innerHTML = '';
                    uploadedCategoryImage = null;
                })
                .catch(error => alert('خطأ في إضافة الفئة: ' + error.message));
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            const newName = prompt('أدخل اسم الفئة الجديد:', category.name);
            if (newName && newName.trim() && newName !== category.name) {
                database.ref('categories/' + categoryId).update({ name: newName.trim() })
                    .then(() => alert('تم تحديث الفئة بنجاح!'))
                    .catch(error => alert('خطأ في تحديث الفئة: ' + error.message));
            }
        }

        function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const productsInCategory = products.filter(p => p.category === category.name);
            if (productsInCategory.length > 0) {
                alert('لا يمكن حذف هذه الفئة لأنها تحتوي على منتجات مسندة إليها.');
                return;
            }

            database.ref('categories/' + categoryId).remove()
                .then(() => alert('تم حذف الفئة بنجاح!'))
                .catch(error => alert('خطأ في حذف الفئة: ' + error.message));
        }

        function addPromoCode() {
            const code = document.getElementById('promoCode').value.trim().toUpperCase();
            const discount = parseFloat(document.getElementById('promoDiscount').value);
            const active = document.getElementById('promoActive').checked;

            if (!code || isNaN(discount) || discount <= 0) {
                alert('يرجى إدخال رمز تخفيض وقيمة خصم صالحين');
                return;
            }

            if (promoCodes.some(p => p.code === code)) {
                alert('رمز التخفيض موجود بالفعل');
                return;
            }

            const newPromoRef = database.ref('promoCodes').push();
            const promoData = {
                id: newPromoRef.key,
                code: code,
                discount: discount,
                active: active
            };

            newPromoRef.set({ code: code, discount: discount, active: active })
                .then(() => {
                    alert('تمت إضافة رمز التخفيض بنجاح!');
                    promoCodeForm.reset();
                    document.getElementById('promoActive').checked = true;
                })
                .catch(error => alert('خطأ في إضافة رمز التخفيض: ' + error.message));
        }

        function editPromoCode(promoId) {
            const promo = promoCodes.find(p => p.id === promoId);
            if (!promo) return;

            const newCode = prompt('أدخل رمز التخفيض الجديد:', promo.code);
            if (!newCode || !newCode.trim()) return;

            const newDiscount = parseFloat(prompt('أدخل قيمة الخصم الجديدة:', promo.discount));
            if (isNaN(newDiscount) || newDiscount <= 0) {
                alert('يرجى إدخال قيمة خصم صالحة');
                return;
            }

            const newActive = confirm('هل تريد أن يبقى رمز التخفيض هذا نشطًا؟');

            database.ref('promoCodes/' + promoId).update({
                code: newCode.trim().toUpperCase(),
                discount: newDiscount,
                active: newActive
            })
            .then(() => alert('تم تحديث رمز التخفيض بنجاح!'))
            .catch(error => alert('خطأ في تحديث رمز التخفيض: ' + error.message));
        }

        function deletePromoCode(promoId) {
            database.ref('promoCodes/' + promoId).remove()
                .then(() => alert('تم حذف رمز التخفيض بنجاح!'))
                .catch(error => alert('خطأ في حذف رمز التخفيض: ' + error.message));
        }

        function updateOrderStatus(orderId, status) {
            if (status === 'cancelled') {
                database.ref('orders/' + orderId).remove()
                    .then(() => alert('تم إلغاء الطلب وحذفه بنجاح!'))
                    .catch(error => alert('خطأ في حذف الطلب: ' + error.message));
            } else {
                database.ref('orders/' + orderId).update({ status: status })
                    .then(() => alert('تم تحديث حالة الطلب بنجاح!'))
                    .catch(error => alert('خطأ في تحديث حالة الطلب: ' + error.message));
            }
        }

        function deleteReview(reviewId) {
            database.ref('reviews/' + reviewId).remove()
                .then(() => alert('تم حذف التقييم بنجاح!'))
                .catch(error => alert('خطأ في حذف التقييم: ' + error.message));
        }

        window.addEventListener('DOMContentLoaded', initAdminPanel);
    </script>
</body>
</html>
